---
title: "DESeq Objects"
author: "Jake Sauter"
date: "3/14/2021"
output: 
  html_document: 
    toc: true
    toc_float: false
    keep_md: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE, 
                      message = FALSE, 
                      comment = NA)
```

## **Background: Creating DESeq2 Objects**

The code below uses the results of `featureCounts` (Unix command line tool) in order to create `DESeq2` objects consisting of the original feature count information in a `DESeqDataSet` (`DESeq.ds`)

```{r}
library(DESeq2)
library(magrittr)

readcounts <-
  read.table('data/featCounts_Gierlinski_genes.txt',
             header = TRUE)

orig_names <- names(readcounts)
names(readcounts) <-
  gsub(".*(WT|SNF2)(_[0-9]+).*", "\\1\\2", orig_names)

## gene IDs should be stored as row.names
row.names(readcounts) <- make.names(readcounts$Geneid)

## exclude the columns without read counts (columns 1 to 6 contain additional
## info such as genomic coordinates)
readcounts <- readcounts[ ,-c(1:6)]

sample_info <- DataFrame(
  condition = gsub("_[0-9]+", "",names(readcounts)),
  row.names =names(readcounts))

DESeq.ds <-DESeqDataSetFromMatrix(
  countData = as.matrix(readcounts),
  colData   = sample_info,
  design    = ~condition)

# Remove genes with no reads
keep_genes <- rowSums(counts(DESeq.ds)) > 0
DESeq.ds <- DESeq.ds[keep_genes, ]

# rlog normalize the data
DESeq.rlog <- rlog(DESeq.ds, blind=TRUE)
rlog.norm.counts <- assay(DESeq.rlog)
```

## **Inspecting DESeq2 Objects**

From the analyses below, we extract the following similarities and differences between the objects returned by `rlog()` and `DESeqDataSetFromMatrix()`

**Similarities**:

-   Both object types returned inherit from the `SummarizedExperiment::SummarizedExperiment` class

-   Both object types share many common slots because of this and allows easy access to metadata about the experiment

**Differences**:

-   `DESeqDataSetFromMatrix()` returns and object of type `DESeqDataSet` while `rlog()` returns an object of type `DESeqTransform`

-   `DESeqDataSet` objects are great at facilitating input processing and normalization functions like `rlog()`, while `DESeqTranform` objects are more result-oriented objects that can be used with functions like `plotPCA()`

### **Classes**

In order to view the classes of `DESeq2` objects, we will make use of the `class()` and `showClass()` built-in functions. `showClass` enables us to easily view the name and class of the **slots** of our objects.

```{r}
DESeq.ds %>% 
  class() %>% 
  showClass()
```

```{r}
class(DESeq.rlog) %>% 
  showClass()
```

**Observed differences:**

-   `DESeqDataSetFromMatrix()` returns an object of class `DESeqDataSet` while `rlog()` returns an object of class `DESeqTransform`
-   As a part in the differences in class type, these objects have different **slots** that store differing information, such as how class `DESeqDataSet` has a `dispersionFunction` slot
-   Both of the objects have a `rowRanges` and `colData` slot, most likely due to inheritance from a shared super-class of `SummarizedExperiment`

## **Inspecting Slots Directly**

We noticed a few differences based on the **slots** of our objects. In order to better observe these differences, we can directly access the names of the slots with `slotNames()` as well as make use of set based operations like `intersect()` and `setdiff()`

```{r}
DESeq.ds %>% 
    slotNames()
```

```{r}
DESeq.rlog %>% 
  slotNames()
```

**Shared Slots**

```{r}
ds_slots <- slotNames(DESeq.ds)
rlog_slots <- slotNames(DESeq.rlog)
intersect(ds_slots, rlog_slots)
```

Above we see that `DESeqDataSet` and `DESeqTransform` share more slots than previously pointed out.

**Unique slots to `DESeqDataSet`**:

```{r}
setdiff(ds_slots, rlog_slots)
```

Here we see specifically that

**Unique slots to `DESeqTransform`**

```{r}
setdiff(rlog_slots, ds_slots)
```

Interestingly, we see here that `DESeqTransform` holds no unique slots in relation to `DESeqDataSet`.

### **Downstream Functions**

`DESeqDataSet`:

-   Great for accessing `counts()`, `assays()`, `colData()` , `rowData()`

```{r, eval=FALSE}
help(DESeqDataSet)
```

> </font size=2.5> DESeqDataSet is a subclass of RangedSummarizedExperiment, **used to store the input values, intermediate calculations and results of an analysis of differential expression**. The DESeqDataSet class enforces non-negative integer values in the "counts" matrix stored as the first element in the assay list. In addition, a formula which specifies the design of the experiment must be provided. The constructor functions create a DESeqDataSet object from various types of input: a RangedSummarizedExperiment, a matrix, count files generated by the python package HTSeq, or a list from the tximport function in the tximport package. See the vignette for examples of construction from different types. </font>

`DESeqTransform` :

-   We can use our `DESeqTransform` object for the `plotPCA()` function as well as other downstream normalized-data expecting functions.

```{r, eval=FALSE}
help(DESeqTransform)
```

> </font size=2.5> This constructor function would not typically be used by "end users". This simple class extends the RangedSummarizedExperiment class of the SummarizedExperiment package. It is used by rlog and varianceStabilizingTransformation **to wrap up the results into a class for downstream methods, such as plotPCA.** </font>

## **Extracting Expression Values**

`DESeqDataSet`:

```{r}
library(knitr)

DESeq.ds %>% 
  counts() %>% 
  head() %>% 
  kable()
```

`DESeqTranfrom`:

By observing the `help(DESeqTransform)` page, we can see that

> <font size=2.5> [If] a DESeqTransform if a DESeqDataSet was provided, or a matrix if a count matrix was provided as input. Note that for DESeqTransform output, the matrix of transformed values is stored in assay(rld). To avoid returning matrices with NA values, in the case of a row of all zeros, the rlog transformation returns zeros (essentially adding a pseudocount of 1 only to these rows). </font>

```{r}
DESeq.rlog %>% 
  assay() %>% 
  head() %>% 
  kable()
```

### **Adding Custom Matrix**

In the following exercise, we will add a custom matrix named `my_personal_normalization` to our `DESeq.ds` object using three different methods.

**Bioconductor Method**

This is possible through the use of the `assay()` accessor and setter function.

```{r}
assay(DESeq.ds, "my_personal_normalization") <- 
  assay(DESeq.ds, 'counts')

DESeq.ds %>% 
  assays()
```

**S4 Inheritance Method**

We may also choose to extend the S4 class with our own sub-class in order to facilitate the use of a **slot**.

```{r}
setClass(
  "myDESeqDataSet",
  contains="DESeqDataSet",
  slots=c(my_personal_normalization="matrix")
) -> myDESeqDataSet

DESeq.ds.mine <- as(DESeq.ds,"myDESeqDataSet")
DESeq.ds.mine@my_personal_normalization <- 
  counts(DESeq.ds)

DESeq.ds.mine %>% 
  class() %>% 
  showClass()
```

**Quick and Dirty Method**

Finally, we can manually set our matrix to be an attribute of the original object.

```{r}
attr(DESeq.ds, "my_personal_normalization") <- 
  counts(DESeq.ds)

DESeq.ds %>% 
  attributes() %>% 
  names()
```

## **Inspecting DESeq2 Source Code**

In the following code blocks we will be using the `::` operator to access functions and objects that **are exported** from the `DESeq2` pacakge, as well as using the `:::` operator to access functions and objects that **are not exported** from the package.

### **rlog()**

```{r}
DESeq2::rlog
```

### **estimateDispersions**

Upon inspection of `estimateDispersions`, we can see that is is actually a **standardGeneric** function, meaning that the heavy-lifting code for each possible input data type is located within a data-type specific function.

```{r}
DESeq2::estimateDispersions
```

Specifically for this task, we are interested in what happens when we call `estimateDispersions` with a `DESeqDataSet` type

```{r}
DESeq2:::estimateDispersions.DESeqDataSet
```

### **rlogData()**

Below, we must use `:::` in order to access `rlogData()` as it is not an exported function.

```{r}
DESeq2:::rlogData
```
